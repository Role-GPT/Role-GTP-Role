/**
 * ì°¨íŠ¸ ë° ê·¸ë˜í”„ ìƒì„± ì„œë¹„ìŠ¤
 * 
 * QuickChart APIì™€ ë„¤ì´ë²„ ë°ì´í„°ë©ì„ í™œìš©í•œ ë°ì´í„° ì‹œê°í™” ê¸°ëŠ¥
 * - ë‹¤ì–‘í•œ ì°¨íŠ¸ íƒ€ì… ì§€ì› (ë¼ì¸, ë§‰ëŒ€, íŒŒì´, ë„ë„›, ì˜ì—­ ì°¨íŠ¸)
 * - ë„¤ì´ë²„ ë°ì´í„°ë© ë°ì´í„° ìë™ ì°¨íŠ¸ ë³€í™˜
 * - ì‚¬ì „ ì •ì˜ëœ ì°¨íŠ¸ í…œí”Œë¦¿ ì œê³µ
 * 
 * @author Role GPT Team
 * @version 1.0.0
 */

import { projectId, publicAnonKey } from '../../../utils/supabase/info';

// ì°¨íŠ¸ ê´€ë ¨ íƒ€ì… ì •ì˜
export interface ChartDataset {
  label: string;
  data: number[];
  backgroundColor?: string | string[];
  borderColor?: string | string[];
  borderWidth?: number;
  fill?: boolean;
}

export interface ChartConfig {
  type: "line" | "bar" | "pie" | "doughnut" | "radar" | "area";
  data: {
    labels: string[];
    datasets: ChartDataset[];
  };
  options?: {
    responsive?: boolean;
    plugins?: {
      title?: {
        display: boolean;
        text: string;
      };
      legend?: {
        display: boolean;
        position?: "top" | "bottom" | "left" | "right";
      };
    };
    scales?: {
      y?: {
        beginAtZero?: boolean;
        title?: {
          display: boolean;
          text: string;
        };
      };
      x?: {
        title?: {
          display: boolean;
          text: string;
        };
      };
    };
  };
}

export interface ChartGenerationOptions {
  width?: number;
  height?: number;
  backgroundColor?: string;
  format?: "png" | "svg" | "webp";
}

export interface ChartTemplate {
  id: string;
  name: string;
  description: string;
  type: string;
  example: ChartConfig;
}

export interface DataLabChartOptions {
  keywords: string[];
  startDate?: string;
  endDate?: string;
  timeUnit?: "date" | "week" | "month";
  chartType?: "line" | "bar" | "area";
  width?: number;
  height?: number;
}

export interface ChartResponse {
  success: boolean;
  chartUrl: string;
  config: ChartConfig;
  rawData?: any;
  summary?: {
    keywords: string[];
    period: string;
    timeUnit: string;
    dataPoints: number;
  };
}

/**
 * ì°¨íŠ¸ ì„œë¹„ìŠ¤ í´ë˜ìŠ¤
 */
class ChartService {
  private baseUrl: string;

  constructor() {
    this.baseUrl = `https://${projectId}.supabase.co/functions/v1/make-server-e3d1d00c`;
  }

  /**
   * ê¸°ë³¸ í—¤ë” ìƒì„±
   */
  private getHeaders(): HeadersInit {
    return {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${publicAnonKey}`
    };
  }

  /**
   * ì¼ë°˜ ì°¨íŠ¸ ìƒì„±
   * 
   * @param config - Chart.js ì„¤ì •
   * @param options - ì°¨íŠ¸ ìƒì„± ì˜µì…˜ (í¬ê¸°, ë°°ê²½ìƒ‰ ë“±)
   * @returns ìƒì„±ëœ ì°¨íŠ¸ URLê³¼ ì„¤ì •
   */
  async generateChart(config: ChartConfig, options: ChartGenerationOptions = {}): Promise<ChartResponse> {
    try {
      console.log('ğŸ“Š ì°¨íŠ¸ ìƒì„± ìš”ì²­:', { type: config.type, options });

      const response = await fetch(`${this.baseUrl}/chart/generate`, {
        method: 'POST',
        headers: this.getHeaders(),
        body: JSON.stringify({
          chart: config,
          ...options
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || `ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨: ${response.status}`);
      }

      const data: ChartResponse = await response.json();
      console.log('âœ… ì°¨íŠ¸ ìƒì„± ì™„ë£Œ:', data.chartUrl);

      return data;
    } catch (error) {
      console.error('ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  /**
   * ë„¤ì´ë²„ ë°ì´í„°ë© ë°ì´í„°ë¥¼ í™œìš©í•œ ì°¨íŠ¸ ìƒì„±
   * 
   * @param options - ë°ì´í„°ë© ì°¨íŠ¸ ìƒì„± ì˜µì…˜
   * @returns ìƒì„±ëœ íŠ¸ë Œë“œ ì°¨íŠ¸ URLê³¼ ë°ì´í„°
   */
  async generateDataLabChart(options: DataLabChartOptions): Promise<ChartResponse> {
    try {
      console.log('ğŸ“Š ë°ì´í„°ë© ì°¨íŠ¸ ìƒì„± ìš”ì²­:', options);

      const response = await fetch(`${this.baseUrl}/chart/datalab`, {
        method: 'POST',
        headers: this.getHeaders(),
        body: JSON.stringify(options)
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || `ë°ì´í„°ë© ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨: ${response.status}`);
      }

      const data: ChartResponse = await response.json();
      console.log('âœ… ë°ì´í„°ë© ì°¨íŠ¸ ìƒì„± ì™„ë£Œ:', data.summary);

      return data;
    } catch (error) {
      console.error('ë°ì´í„°ë© ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  /**
   * ì°¨íŠ¸ í…œí”Œë¦¿ ëª©ë¡ ì¡°íšŒ
   * 
   * @returns ì‚¬ìš© ê°€ëŠ¥í•œ ì°¨íŠ¸ í…œí”Œë¦¿ ëª©ë¡
   */
  async getChartTemplates(): Promise<ChartTemplate[]> {
    try {
      console.log('ğŸ“‹ ì°¨íŠ¸ í…œí”Œë¦¿ ì¡°íšŒ');

      const response = await fetch(`${this.baseUrl}/chart/templates`, {
        method: 'GET',
        headers: this.getHeaders()
      });

      if (!response.ok) {
        throw new Error(`í…œí”Œë¦¿ ì¡°íšŒ ì‹¤íŒ¨: ${response.status}`);
      }

      const data = await response.json();
      console.log('âœ… ì°¨íŠ¸ í…œí”Œë¦¿ ì¡°íšŒ ì™„ë£Œ:', data.templates.length, 'ê°œ');

      return data.templates;
    } catch (error) {
      console.error('ì°¨íŠ¸ í…œí”Œë¦¿ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  /**
   * ê²€ìƒ‰ì–´ íŠ¸ë Œë“œ ë¹„êµ ì°¨íŠ¸ ìƒì„± (ê°„ë‹¨í•œ í—¬í¼ ë©”ì„œë“œ)
   * 
   * @param keywords - ë¹„êµí•  ê²€ìƒ‰ì–´ë“¤
   * @param months - ì¡°íšŒí•  ê°œì›” ìˆ˜ (ê¸°ë³¸ 12ê°œì›”)
   * @returns ìƒì„±ëœ íŠ¸ë Œë“œ ë¹„êµ ì°¨íŠ¸
   */
  async generateTrendComparison(keywords: string[], months: number = 12): Promise<ChartResponse> {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setMonth(endDate.getMonth() - months);

    return this.generateDataLabChart({
      keywords,
      startDate: startDate.toISOString().split('T')[0],
      endDate: endDate.toISOString().split('T')[0],
      timeUnit: "month",
      chartType: "line",
      width: 800,
      height: 400
    });
  }

  /**
   * ë‹¨ìˆœ ë°ì´í„°ë¥¼ ë§‰ëŒ€ ì°¨íŠ¸ë¡œ ë³€í™˜
   * 
   * @param title - ì°¨íŠ¸ ì œëª©
   * @param labels - ë°ì´í„° ë ˆì´ë¸”ë“¤
   * @param values - ë°ì´í„° ê°’ë“¤
   * @param options - ì¶”ê°€ ì˜µì…˜
   * @returns ìƒì„±ëœ ë§‰ëŒ€ ì°¨íŠ¸
   */
  async generateSimpleBarChart(
    title: string,
    labels: string[],
    values: number[],
    options: ChartGenerationOptions = {}
  ): Promise<ChartResponse> {
    const colors = [
      "rgba(59, 130, 246, 0.8)",   // íŒŒë‘
      "rgba(239, 68, 68, 0.8)",    // ë¹¨ê°•
      "rgba(34, 197, 94, 0.8)",    // ì´ˆë¡
      "rgba(251, 146, 60, 0.8)",   // ì£¼í™©
      "rgba(168, 85, 247, 0.8)",   // ë³´ë¼
    ];

    const config: ChartConfig = {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "ê°’",
          data: values,
          backgroundColor: colors.slice(0, values.length)
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: title
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    };

    return this.generateChart(config, options);
  }

  /**
   * ë‹¨ìˆœ ë°ì´í„°ë¥¼ íŒŒì´ ì°¨íŠ¸ë¡œ ë³€í™˜
   * 
   * @param title - ì°¨íŠ¸ ì œëª©
   * @param labels - ë°ì´í„° ë ˆì´ë¸”ë“¤
   * @param values - ë°ì´í„° ê°’ë“¤
   * @param options - ì¶”ê°€ ì˜µì…˜
   * @returns ìƒì„±ëœ íŒŒì´ ì°¨íŠ¸
   */
  async generateSimplePieChart(
    title: string,
    labels: string[],
    values: number[],
    options: ChartGenerationOptions = {}
  ): Promise<ChartResponse> {
    const colors = [
      "rgba(59, 130, 246, 0.8)",
      "rgba(239, 68, 68, 0.8)",
      "rgba(34, 197, 94, 0.8)",
      "rgba(251, 146, 60, 0.8)",
      "rgba(168, 85, 247, 0.8)",
      "rgba(236, 72, 153, 0.8)",
      "rgba(14, 165, 233, 0.8)",
      "rgba(99, 102, 241, 0.8)"
    ];

    const config: ChartConfig = {
      type: "pie",
      data: {
        labels,
        datasets: [{
          label: "ë¶„í¬",
          data: values,
          backgroundColor: colors.slice(0, values.length)
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: title
          },
          legend: {
            display: true,
            position: "right"
          }
        }
      }
    };

    return this.generateChart(config, options);
  }
}

// ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ export
export const chartService = new ChartService();

// í¸ì˜ í•¨ìˆ˜ë“¤
export const generateChart = (config: ChartConfig, options?: ChartGenerationOptions) => 
  chartService.generateChart(config, options);

export const generateDataLabChart = (options: DataLabChartOptions) => 
  chartService.generateDataLabChart(options);

export const generateTrendComparison = (keywords: string[], months?: number) => 
  chartService.generateTrendComparison(keywords, months);

export const generateSimpleBarChart = (title: string, labels: string[], values: number[], options?: ChartGenerationOptions) => 
  chartService.generateSimpleBarChart(title, labels, values, options);

export const generateSimplePieChart = (title: string, labels: string[], values: number[], options?: ChartGenerationOptions) => 
  chartService.generateSimplePieChart(title, labels, values, options);

export const getChartTemplates = () => chartService.getChartTemplates();