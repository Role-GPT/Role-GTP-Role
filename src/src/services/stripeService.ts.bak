/**
 * Stripe ê²°ì œ ì„œë¹„ìŠ¤
 * 
 * Stripe ê²°ì œ, êµ¬ë… ê´€ë¦¬, ìƒíƒœ ì¡°íšŒ ê¸°ëŠ¥
 */

import { projectId, publicAnonKey } from '../../../utils/supabase/info';

const API_BASE_URL = `https://${projectId}.supabase.co/functions/v1/make-server-e3d1d00c`;

// Stripe ê´€ë ¨ íƒ€ì… ì •ì˜
export interface StripeCheckoutSession {
  sessionId: string;
  url: string;
  success: boolean;
}

export interface StripePortalSession {
  url: string;
  success: boolean;
}

export interface SubscriptionStatus {
  hasSubscription: boolean;
  status: 'active' | 'canceled' | 'expired' | 'none';
  subscription?: {
    status: string;
    customerId: string;
    priceId: string;
    currentPeriodStart: string;
    currentPeriodEnd: string;
    isExpired: boolean;
    daysRemaining: number;
  };
  message?: string;
}

/**
 * Stripe ì²´í¬ì•„ì›ƒ ì„¸ì…˜ ìƒì„±
 * @param priceId Stripe Price ID (ì˜ˆ: price_1234567890)
 * @param userId ì‚¬ìš©ì ID
 * @param email ì‚¬ìš©ì ì´ë©”ì¼ (ì„ íƒ)
 * @returns Promise<StripeCheckoutSession>
 */
export async function createCheckoutSession(
  priceId: string,
  userId: string,
  email?: string
): Promise<StripeCheckoutSession> {
  try {
    console.log('ğŸ’³ Stripe ì²´í¬ì•„ì›ƒ ì„¸ì…˜ ìƒì„±:', { priceId, userId });
    
    const response = await fetch(`${API_BASE_URL}/stripe/create-checkout-session`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${publicAnonKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        priceId,
        userId,
        email,
        successUrl: `${window.location.origin}/success?session_id={CHECKOUT_SESSION_ID}`,
        cancelUrl: `${window.location.origin}/cancel`
      }),
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'ì²´í¬ì•„ì›ƒ ì„¸ì…˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }

    const data = await response.json();
    console.log('âœ… Stripe ì²´í¬ì•„ì›ƒ ì„¸ì…˜ ìƒì„± ì™„ë£Œ');
    
    return data;
  } catch (error) {
    console.error('Stripe ì²´í¬ì•„ì›ƒ ì„¸ì…˜ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
    throw error;
  }
}

/**
 * Stripe êµ¬ë… ê´€ë¦¬ í¬í„¸ ì„¸ì…˜ ìƒì„±
 * @param customerId Stripe Customer ID
 * @returns Promise<StripePortalSession>
 */
export async function createPortalSession(customerId: string): Promise<StripePortalSession> {
  try {
    console.log('ğŸ›ï¸ Stripe í¬í„¸ ì„¸ì…˜ ìƒì„±:', customerId);
    
    const response = await fetch(`${API_BASE_URL}/stripe/create-portal-session`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${publicAnonKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        customerId,
        returnUrl: window.location.origin
      }),
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'í¬í„¸ ì„¸ì…˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }

    const data = await response.json();
    console.log('âœ… Stripe í¬í„¸ ì„¸ì…˜ ìƒì„± ì™„ë£Œ');
    
    return data;
  } catch (error) {
    console.error('Stripe í¬í„¸ ì„¸ì…˜ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
    throw error;
  }
}

/**
 * ì‚¬ìš©ì êµ¬ë… ìƒíƒœ ì¡°íšŒ
 * @param userId ì‚¬ìš©ì ID
 * @returns Promise<SubscriptionStatus>
 */
export async function getSubscriptionStatus(userId: string): Promise<SubscriptionStatus> {
  try {
    console.log('ğŸ“Š êµ¬ë… ìƒíƒœ ì¡°íšŒ:', userId);
    
    const response = await fetch(`${API_BASE_URL}/subscription/${userId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${publicAnonKey}`,
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'êµ¬ë… ìƒíƒœ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }

    const data = await response.json();
    console.log('âœ… êµ¬ë… ìƒíƒœ ì¡°íšŒ ì™„ë£Œ:', data.hasSubscription ? 'êµ¬ë… ì¤‘' : 'êµ¬ë… ì—†ìŒ');
    
    return data;
  } catch (error) {
    console.error('êµ¬ë… ìƒíƒœ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', error);
    throw error;
  }
}

/**
 * ê²°ì œ ì™„ë£Œ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸
 * @param priceId Stripe Price ID
 * @param userId ì‚¬ìš©ì ID
 * @param email ì‚¬ìš©ì ì´ë©”ì¼ (ì„ íƒ)
 */
export async function redirectToCheckout(
  priceId: string, 
  userId: string, 
  email?: string
): Promise<void> {
  try {
    const session = await createCheckoutSession(priceId, userId, email);
    
    if (session.url) {
      window.location.href = session.url;
    } else {
      throw new Error('ì²´í¬ì•„ì›ƒ URLì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
    }
  } catch (error) {
    console.error('ê²°ì œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹¤íŒ¨:', error);
    throw error;
  }
}

/**
 * êµ¬ë… ê´€ë¦¬ í¬í„¸ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
 * @param customerId Stripe Customer ID
 */
export async function redirectToPortal(customerId: string): Promise<void> {
  try {
    const session = await createPortalSession(customerId);
    
    if (session.url) {
      window.location.href = session.url;
    } else {
      throw new Error('í¬í„¸ URLì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
    }
  } catch (error) {
    console.error('í¬í„¸ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹¤íŒ¨:', error);
    throw error;
  }
}

/**
 * ì‚¬ìš©ì ID ìƒì„± ë˜ëŠ” ê°€ì ¸ì˜¤ê¸° (Stripe ì—°ë™ìš©)
 * @returns string
 */
export function getCurrentUserId(): string {
  let userId = localStorage.getItem('role_gpt_user_id');
  if (!userId) {
    userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem('role_gpt_user_id', userId);
  }
  return userId;
}

import { STRIPE_CONFIG } from '../constants/environment';

// Stripe ê°€ê²© í”Œëœ ì •ì˜ (ì‹¤ì œ Price IDë¡œ ì„¤ì •)
export const STRIPE_PRICES = {
  STANDARD: STRIPE_CONFIG.prices.standard, // $9.99/ì›”
  ADVANCED: STRIPE_CONFIG.prices.advanced, // $19.99/ì›”  
  EXPERT: STRIPE_CONFIG.prices.expert,     // $39.99/ì›”
} as const;

// í”Œëœ ì •ë³´
export const PLANS = {
  STANDARD: {
    name: 'Standard',
    priceId: STRIPE_PRICES.STANDARD,
    price: '$9.99',
    interval: 'ì›”',
    features: [
      'ìµœëŒ€ 2ê°œ í”„ë¡œì íŠ¸',
      '10ê°œ ëŒ€í™”',
      '6ê°œ ì»¤ìŠ¤í…€ ì—­í• ',
      'ê¸°ë³¸ íƒ€ì„ë¼ì¸ ê¸°ëŠ¥',
      'ì´ë©”ì¼ ì§€ì›'
    ]
  },
  ADVANCED: {
    name: 'Advanced',
    priceId: STRIPE_PRICES.ADVANCED,
    price: '$19.99',
    interval: 'ì›”',
    features: [
      'ìµœëŒ€ 10ê°œ í”„ë¡œì íŠ¸',
      '50ê°œ ëŒ€í™”',
      '15ê°œ ì»¤ìŠ¤í…€ ì—­í• ',
      'ê³ ê¸‰ íƒ€ì„ë¼ì¸ & ìš”ì•½',
      'ìš°ì„  ì§€ì›',
      'ë°ì´í„° ë‚´ë³´ë‚´ê¸°'
    ]
  },
  EXPERT: {
    name: 'Expert',
    priceId: STRIPE_PRICES.EXPERT,
    price: '$39.99',
    interval: 'ì›”',
    features: [
      'ë¬´ì œí•œ í”„ë¡œì íŠ¸',
      'ë¬´ì œí•œ ëŒ€í™”',
      'ë¬´ì œí•œ ì»¤ìŠ¤í…€ ì—­í• ',
      'ëª¨ë“  ê³ ê¸‰ ê¸°ëŠ¥',
      '24/7 ì „ìš© ì§€ì›',
      'API ì•¡ì„¸ìŠ¤',
      'íŒ€ í˜‘ì—… ê¸°ëŠ¥'
    ]
  }
} as const;